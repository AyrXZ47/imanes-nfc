<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StikerTunning - Panel de Control</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.4.19/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üöÄ</text></svg>">
</head>
<body class="bg-slate-900 text-white font-sans">

    <nav class="bg-slate-800 border-b border-slate-700 p-4">
      <div class="container mx-auto flex justify-between items-center">
        
        <div class="flex items-center gap-4">
            <h1 class="text-xl font-bold text-white flex items-center gap-2">
                üöÄ StikerTunning <span class="hidden md:inline">Analytics</span>
            </h1>
            <span class="text-xs bg-green-500/20 text-green-400 px-2 py-1 rounded-full border border-green-500/30 flex items-center gap-1">
                <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                Online
            </span>
        </div>

        <div>
            <a href="/auth/logout" class="text-sm bg-red-500/10 text-red-400 hover:bg-red-500 hover:text-white border border-red-500/30 px-4 py-2 rounded-lg transition flex items-center gap-2">
                <span>Cerrar Sesi√≥n</span>
                üö™
            </a>
        </div>
        
      </div>
    </nav>
    <div class="container mx-auto p-6 space-y-8">
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="bg-slate-800 p-6 rounded-xl border border-slate-700 shadow-lg">
                <h3 class="text-slate-400 text-sm font-medium uppercase">Productos Configurados</h3>
                <p class="text-4xl font-bold text-white mt-2">{{ activos }}</p>
                <div class="mt-2 text-xs text-green-400">üî• Clientes con URL activa</div>
            </div>
            <div class="bg-slate-800 p-6 rounded-xl border border-slate-700 shadow-lg">
                <h3 class="text-slate-400 text-sm font-medium uppercase">Links Disponibles</h3>
                <p class="text-4xl font-bold text-white mt-2">{{ disponibles }}</p>
                <div class="mt-2 text-xs text-yellow-400">üì¶ Listos para grabaci√≥n</div>
            </div>
            <div class="bg-slate-800 p-6 rounded-xl border border-slate-700 shadow-lg">
                <h3 class="text-slate-400 text-sm font-medium uppercase">Total Fabricados</h3>
                <p class="text-4xl font-bold text-white mt-2">{{ total }}</p>
                <div class="mt-2 text-xs text-blue-400">üè≠ Capacidad instalada</div>
            </div>
        </div>

        <!-- Estad√≠sticas Mensuales (Movidas aqu√≠) -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-slate-800 p-6 rounded-xl border border-slate-700 shadow-lg flex items-center justify-between">
                <div>
                    <h3 class="text-slate-400 text-sm font-medium uppercase">Activados este Mes</h3>
                    <p class="text-3xl font-bold text-white mt-1">{{ activos_mes }}</p>
                </div>
                <div class="text-4xl">üìÖ</div>
            </div>

            <div class="bg-slate-800 p-6 rounded-xl border border-slate-700 shadow-lg flex items-center justify-between">
                <div>
                    <h3 class="text-slate-400 text-sm font-medium uppercase">Mes Anterior</h3>
                    <p class="text-3xl font-bold text-gray-400 mt-1">{{ activos_mes_ant }}</p>
                </div>
                <div class="text-4xl opacity-50">‚èÆÔ∏è</div>
            </div>
        </div>

        <!-- Cambio B: El Nuevo Panel de Generaci√≥n (Con Nombre) -->
        <div class="card bg-slate-800 shadow-xl mb-8 border border-gray-700">
            <div class="card-body">
                <h2 class="card-title text-accent">üè≠ Generar Nuevo Lote de Producci√≥n</h2>
                <form action="/api/admin/generate" method="POST" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    
                    <div class="form-control">
                        <label class="label"><span class="label-text text-gray-300">Nombre del Lote / Cliente</span></label>
                        <input type="text" name="nombre_lote" placeholder="Huasteca" class="input input-bordered bg-slate-900 border-slate-600" required />
                    </div>

                    <div class="form-control">
                        <label class="label"><span class="label-text text-gray-300">Cantidad de Links</span></label>
                        <input type="number" name="cantidad" placeholder="50" class="input input-bordered bg-slate-900 border-slate-600" required min="1" max="1000" />
                    </div>

                    <div class="form-control mt-9">
                        <button type="submit" class="btn btn-primary">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg>
                            Fabricar Lote
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Cambio C: La Tabla "Blockchain" de Lotes (Con Buscador) -->
        <div class="card bg-slate-800 shadow-xl mb-8 border border-gray-700">
            <div class="card-body">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="card-title text-white">üì¶ Historial de Lotes</h2>
                    <input type="text" id="loteSearch" placeholder="Buscar lote..." class="input input-sm input-bordered w-full max-w-xs bg-slate-900 border-slate-600" onkeyup="filterLotes()" />
                </div>

                <div class="overflow-x-auto max-h-96 overflow-y-auto"> 
                    <table class="table w-full" id="lotesTable">
                        <thead>
                                                        <tr class="text-gray-400 border-slate-700">
                                                            <th>Fecha de Creaci√≥n</th>
                                                            <th>Nombre del Lote / Cliente</th>
                                                            <th>Total Links</th>
                                                            <th>Grabados (NFC)</th>
                                                            <th>Acciones de Exportaci√≥n</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {% for lote in lotes %}
                                                        <tr class="hover:bg-slate-700/50 border-slate-700">
                                                            <td>{{ lote.fecha | date(format="%d/%m/%Y") }}</td>
                                                            <td class="font-bold text-accent">{{ lote.nombre }}</td>
                                                            <td>{{ lote.total }}</td>
                                                            <td>
                                                                <div class="badge badge-info gap-2">{{ lote.asignados }}</div>
                                                            </td>
                                                            <td>
                                                                <div class="dropdown dropdown-left">
                                                                    <label tabindex="0" class="btn btn-sm btn-outline btn-info">‚¨áÔ∏è Descargar</label>
                                                                    <ul tabindex="0" class="dropdown-content menu p-2 shadow bg-base-100 rounded-box w-52 border border-gray-600 z-[1]">
                                                                        <li><a href="/api/csv/{{ lote.nombre }}/full?ts={{ lote.timestamp }}">üìÑ Lote Completo</a></li>
                                                                        <li><a href="/api/csv/{{ lote.nombre }}/available?ts={{ lote.timestamp }}" class="text-green-400">üõ°Ô∏è Solo Disponibles</a></li>
                                                                    </ul>
                                                                </div>
                                                            </td>
                                                        </tr>
                                                        {% endfor %}
                            
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="bg-slate-800 p-6 rounded-xl border border-slate-700">
            <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                üõ†Ô∏è Herramienta de Grabado NFC
            </h2>
            <p class="text-slate-400 mb-4 text-sm">
                Genera el enlace para grabar en el chip. Copia esto en tu app de "NFC Tools".
            </p>
            <div class="flex gap-4">
                <input type="text" id="codigoInput" placeholder="Ej: PUEBLO-001" 
                    class="bg-slate-900 border border-slate-600 rounded-lg p-3 flex-1 focus:ring-2 focus:ring-purple-500 outline-none uppercase">
                <button onclick="generarLink()" 
                    class="bg-purple-600 hover:bg-purple-700 px-6 py-3 rounded-lg font-bold transition">
                    Generar Link
                </button>
            </div>
            <div id="resultadoLink" class="mt-4 hidden p-4 bg-slate-900 rounded-lg border border-purple-500/30 flex justify-between items-center">
                <code id="linkText" class="text-purple-300 font-mono text-sm"></code>
                <button onclick="copiarLink()" class="text-xs bg-slate-700 px-3 py-1 rounded hover:bg-slate-600">Copiar</button>
            </div>
        </div>

        <div class="bg-slate-800 rounded-xl border border-slate-700 overflow-hidden">
            <div class="p-6 border-b border-slate-700">
                <h2 class="text-xl font-bold">üèÜ Top Viral (Lo m√°s escaneado)</h2>
            <div class="bg-slate-800 p-6 rounded-xl border border-slate-700 shadow-lg mt-6">
                <h2 class="text-xl font-bold mb-4">üìà Tendencia de Viralidad</h2>
            <div class="h-64">
            <canvas id="viralChart"></canvas>
            </div>
            </div>
            <div class="bg-slate-800 p-6 rounded-xl border border-slate-700 shadow-lg mt-6">
              <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                üöÄ Crecimiento de Activaciones
              </h2>
            <div class="h-64">
              <canvas id="growthChart"></canvas>
            </div>
            </div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left text-sm text-slate-400">
                    <thead class="bg-slate-900 text-slate-200 uppercase font-medium">
                        <tr>
                            <th class="px-6 py-3">C√≥digo</th>
                            <th class="px-6 py-3">Destino Actual</th>
                            <th class="px-6 py-3 text-right">Scans</th>
                            <th class="px-6 py-3">√öltima Actividad</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-700">
                        {% for iman in top_imanes %}
                        <tr class="hover:bg-slate-700/50 transition">
                            <td class="px-6 py-4 font-mono text-white">{{ iman.codigo }}</td>
                            <td class="px-6 py-4 truncate max-w-xs">
                                <a href="{{ iman.target_url }}" target="_blank" class="text-blue-400 hover:underline">
                                    {{ iman.target_url }}
                                </a>
                            </td>
                            <td class="px-6 py-4 text-right font-bold text-green-400">{{ iman.visitas }}</td>
                            <td class="px-6 py-4 text-xs text-gray-400">
                                    {% if iman.last_scan_at %}
                                    {{ iman.last_scan_at | date(format="%Y-%m-%d %H:%M") }}
                                    {% else %}
                              <span class="text-slate-600">Sin historial</span>
                                    {% endif %}
                            </td>


                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% if top_imanes | length == 0 %}
                <div class="p-6 text-center text-slate-500">
                    A√∫n no hay datos de visitas. ¬°Empieza a compartir los imanes!
                </div>
                {% endif %}
            </div>
        </div>


    </div>

    <script>
        const baseUrl = "{{ base_url | safe }}";

        function generarLink() {
            const codigo = document.getElementById('codigoInput').value.trim().toUpperCase();
            if (!codigo) return;
            
            const fullLink = `${baseUrl}/v/${codigo}`;
            document.getElementById('linkText').innerText = fullLink;
            document.getElementById('resultadoLink').classList.remove('hidden');
        }

        function copiarLink() {
            const text = document.getElementById('linkText').innerText;
            navigator.clipboard.writeText(text);
            alert("Link copiado al portapapeles üìã");
        }

        function filterLotes() {
            const input = document.getElementById('loteSearch');
            const filter = input.value.toLowerCase();
            const table = document.getElementById('lotesTable');
            const tr = table.getElementsByTagName('tr');

            for (let i = 1; i < tr.length; i++) {
                const td = tr[i].getElementsByTagName('td')[1]; // Columna de nombre
                if (td) {
                    const txtValue = td.textContent || td.innerText;
                    if (txtValue.toLowerCase().indexOf(filter) > -1) {
                        tr[i].style.display = "";
                    } else {
                        tr[i].style.display = "none";
                    }
                }
            }
        }
    </script>
    <script>

    // CONFIGURACI√ìN DE LA GR√ÅFICA
    const ctx = document.getElementById('viralChart').getContext('2d');
    
    // Cambio D: Script para el Top 10
    const rawLabels = [{% for iman in top_imanes %}"{{ iman.codigo }}",{% endfor %}];
    const rawData = [{% for iman in top_imanes %}{{ iman.visitas }},{% endfor %}];
    
    const topLabels = rawLabels.slice(0, 10);
    const topData = rawData.slice(0, 10);

    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: topLabels,
            datasets: [{
                label: 'Escaneos Totales',
                data: topData,
                backgroundColor: 'rgba(168, 85, 247, 0.6)', 
                borderColor: 'rgba(168, 85, 247, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    grid: { color: 'rgba(255, 255, 255, 0.1)' } // L√≠neas sutiles
                },
                x: {
                    grid: { display: false }
                }
            },
            plugins: {
                legend: { labels: { color: '#94a3b8' } } // Texto gris claro
            }
        }
    });
    </script>
    <script>
    // ... tu c√≥digo anterior ...

    // GR√ÅFICA DE L√çNEAS (CRECIMIENTO)
    const ctxGrowth = document.getElementById('growthChart').getContext('2d');
    const growthData = [{{ chart_data | join(sep=",") }}]; // Datos de Rust
    const growthLabels = [{% for l in chart_labels %}"{{l}}",{% endfor %}];

    new Chart(ctxGrowth, {
        type: 'line',
        data: {
            labels: growthLabels,
            datasets: [{
                label: 'Imanes Activados',
                data: growthData,
                borderColor: '#10b981', // Verde esmeralda
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                borderWidth: 3,
                tension: 0.4, // Curva suave
                fill: true,
                pointBackgroundColor: '#fff',
                pointRadius: 5
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' } },
                x: { grid: { display: false } }
            },
            plugins: { legend: { display: false } }
        }
    });
</script>
</body>
</html>
